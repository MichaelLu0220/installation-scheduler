<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工單詳情 - 智慧安裝排程平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
  <div class="max-w-7xl mx-auto px-6 py-6">
    <!-- 統一的導航欄 -->
    <div class="flex items-center gap-3 mb-5">
      <div class="text-xl font-semibold">智慧安裝排程平台</div>
      <span class="ml-2 inline-flex items-center rounded-full bg-blue-100 text-blue-800 px-2 py-0.5 text-xs">Firsttech Demo</span>
      <div class="ml-auto flex items-center gap-2">
        <a href="/dashboard" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">總覽</a>
        <a href="/jobs" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">工單管理</a>
        <a href="/scheduler" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">排程檢視</a>
        <a href="/workers" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">技師管理</a>
        <a href="/db/orders" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50">資料總覽</a>
        <a href="/order-input" class="px-3 py-1.5 rounded-xl border bg-green-600 text-white hover:bg-green-700">新增訂單</a>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4" th:if="${job != null}">
      <div class="col-span-12 lg:col-span-8 space-y-4">
        <!-- 工單基本資訊 -->
        <div class="bg-white rounded-2xl border shadow-sm">
          <div class="px-5 pt-4 pb-2">
            <div class="text-base font-semibold flex items-center gap-3">
              <a href="/jobs" class="px-3 py-1.5 rounded-xl border hover:bg-gray-50 text-sm">← 返回</a>
              <span th:text="${job.formattedJobId}">工單-1</span>
              <span class="text-lg font-bold text-blue-600" th:text="${job.machineName}">M1</span>
              
              <!-- 狀態標籤 -->
              <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"
                    th:classappend="${job.status == 'ON_TIME'} ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                    th:text="${job.status == 'ON_TIME'} ? '✅ 準時' : '❌ 延遲風險'">準時</span>
                    
              <!-- 優先級標籤 -->
              <span th:if="${job.priority == 'High'}" 
                    class="inline-flex items-center rounded-full bg-red-100 text-red-700 px-3 py-1 text-sm font-medium">
                🔥 緊急處理
              </span>
              <span th:if="${job.priority == 'Medium'}" 
                    class="inline-flex items-center rounded-full bg-yellow-100 text-yellow-700 px-3 py-1 text-sm font-medium">
                ⚡ 優先處理
              </span>
            </div>
          </div>
          
          <div class="px-5 pb-5 grid grid-cols-12 gap-4 text-sm">
            <div class="col-span-12 md:col-span-6">
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-500">截止日期：</span>
                  <span class="font-mono" 
                        th:classappend="${job.isDueSoon()} ? 'text-red-600 font-bold' : 'text-gray-900'"
                        th:text="${job.dueDate}">2025-10-15</span>
                </div>
                <div th:if="${job.etaDate != null}" class="flex justify-between">
                  <span class="text-gray-500">預計完成：</span>
                  <span class="font-mono text-blue-600" th:text="${job.etaDate}">2025-09-28</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">處理策略：</span>
                  <span class="font-medium" th:text="${job.strategy}">Partial</span>
                </div>
              </div>
            </div>
            
            <div class="col-span-12 md:col-span-6">
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-500">剩餘天數：</span>
                  <span class="font-mono font-bold"
                        th:classappend="${job.daysUntilDue < 0} ? 'text-red-600' : (${job.daysUntilDue <= 7} ? 'text-orange-600' : 'text-green-600')"
                        th:text="${job.daysUntilDue < 0 ? '已逾期 ' + (-job.daysUntilDue) + ' 天' : job.daysUntilDue + ' 天'}">10 天</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">材料滿足率：</span>
                  <span class="font-mono font-bold"
                        th:classappend="${job.materialSatisfactionRate < 100} ? 'text-red-600' : 'text-green-600'"
                        th:text="${#numbers.formatDecimal(job.materialSatisfactionRate, 0, 1)} + '%'">85.5%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">材料風險：</span>
                  <span th:if="${job.hasMaterialRisk()}" class="text-red-600 font-medium">⚠️ 有缺料風險</span>
                  <span th:unless="${job.hasMaterialRisk()}" class="text-green-600 font-medium">✅ 材料充足</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 材料需求詳細資訊 -->
        <div class="bg-white rounded-2xl border shadow-sm">
          <div class="px-5 pt-4 pb-2">
            <div class="text-base font-semibold">材料需求與庫存分析</div>
            <div class="text-sm text-gray-500">各項材料的需求量、庫存量與缺口分析</div>
          </div>
          <div class="px-5 pb-5">
            <div th:if="${job.materials != null and !#lists.isEmpty(job.materials)}">
              <!-- 材料總覽進度條 -->
              <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">整體材料滿足進度</span>
                  <span class="font-bold" 
                        th:classappend="${job.materialSatisfactionRate < 100} ? 'text-red-600' : 'text-green-600'"
                        th:text="${#numbers.formatDecimal(job.materialSatisfactionRate, 0, 1)} + '%'">85.5%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="h-3 rounded-full transition-all duration-500"
                       th:classappend="${job.materialSatisfactionRate < 100} ? 'bg-red-500' : 'bg-green-500'"
                       th:style="'width: ' + ${job.materialSatisfactionRate} + '%'"></div>
                </div>
              </div>
              
              <!-- 材料明細表格 -->
              <div class="overflow-hidden border border-gray-200 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">材料</th>
                      <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">需求量</th>
                      <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">庫存量</th>
                      <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">缺口</th>
                      <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">滿足率</th>
                      <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr th:each="material : ${job.materials}" class="hover:bg-gray-50">
                      <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="w-3 h-3 rounded-full mr-3"
                               th:classappend="${material.shortage > 0} ? 'bg-red-500' : 'bg-green-500'"></div>
                          <span class="font-medium text-gray-900" th:text="${material.material}">氮氣管</span>
                        </div>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="font-mono text-sm" th:text="${material.qtyNeeded}">80</span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="font-mono text-sm" th:text="${material.qtyOnHand}">30</span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="font-mono text-sm font-bold"
                              th:classappend="${material.shortage > 0} ? 'text-red-600' : 'text-green-600'"
                              th:text="${material.shortage > 0 ? material.shortage : '0'}">50</span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="font-mono text-sm font-bold"
                              th:classappend="${material.satisfactionRate < 100} ? 'text-red-600' : 'text-green-600'"
                              th:text="${#numbers.formatDecimal(material.satisfactionRate, 0, 1)} + '%'">37.5%</span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span th:if="${material.shortage == 0}" 
                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          ✅ 充足
                        </span>
                        <span th:if="${material.shortage > 0}" 
                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                          ⚠️ 不足
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- 如果沒有材料需求 -->
            <div th:if="${job.materials == null or #lists.isEmpty(job.materials)}" 
                 class="text-center text-gray-500 py-8">
              <div class="text-lg">📦 暫無材料需求資料</div>
              <div class="text-sm mt-2">此工單尚未設定材料需求</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 右側信息面板 -->
      <div class="col-span-12 lg:col-span-4 space-y-4">
        <!-- 快速操作 -->
        <div class="bg-white rounded-2xl border shadow-sm">
          <div class="px-5 pt-4 pb-2">
            <div class="text-base font-semibold">快速操作</div>
          </div>
          <div class="px-5 pb-5 space-y-3">
            <a href="#" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center block">
              📋 編輯工單
            </a>
            <a href="#" class="w-full px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition-colors text-center block">
              ✅ 標記完成
            </a>
            <a href="#" class="w-full px-4 py-2 border border-yellow-600 text-yellow-600 rounded-lg hover:bg-yellow-50 transition-colors text-center block">
              ⏸️ 暫停工單
            </a>
            <a href="#" class="w-full px-4 py-2 border border-red-600 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-center block">
              🗑️ 取消工單
            </a>
          </div>
        </div>

        <!-- 相關建議 -->
        <div class="bg-white rounded-2xl border shadow-sm">
          <div class="px-5 pt-4 pb-2">
            <div class="text-base font-semibold">系統建議</div>
          </div>
          <div class="px-5 pb-5 space-y-3 text-sm">
            <div th:if="${job.hasMaterialRisk()}" class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <div class="font-medium text-red-800 mb-1">⚠️ 材料風險警告</div>
              <div class="text-red-700">此工單存在材料短缺風險，建議：</div>
              <ul class="mt-2 text-red-600 text-xs space-y-1">
                <li>• 檢查近期到貨計劃</li>
                <li>• 考慮調整工單優先順序</li>
                <li>• 聯繫供應商加急處理</li>
              </ul>
            </div>
            
            <div th:if="${job.isDueSoon()}" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div class="font-medium text-yellow-800 mb-1">⏰ 時程緊急提醒</div>
              <div class="text-yellow-700">此工單即將到期，建議：</div>
              <ul class="mt-2 text-yellow-600 text-xs space-y-1">
                <li>• 優先安排技師資源</li>
                <li>• 確認材料備貨狀況</li>
                <li>• 準備應急處理方案</li>
              </ul>
            </div>
            
            <div th:unless="${job.hasMaterialRisk() or job.isDueSoon()}" class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <div class="font-medium text-green-800 mb-1">✅ 狀況良好</div>
              <div class="text-green-700 text-xs">此工單目前狀況正常，可按計劃執行</div>
            </div>
          </div>
        </div>

        <!-- 工單歷史 -->
        <div class="bg-white rounded-2xl border shadow-sm">
          <div class="px-5 pt-4 pb-2">
            <div class="text-base font-semibold">工單歷史</div>
          </div>
          <div class="px-5 pb-5">
            <div class="space-y-3">
              <div class="flex items-start gap-3 text-sm">
                <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                <div>
                  <div class="font-medium">工單建立</div>
                  <div class="text-gray-500 text-xs">系統自動建立</div>
                  <div class="text-gray-400 text-xs">剛才</div>
                </div>
              </div>
              <div class="flex items-start gap-3 text-sm">
                <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                <div>
                  <div class="font-medium">材料檢查完成</div>
                  <div class="text-gray-500 text-xs">系統自動檢查</div>
                  <div class="text-gray-400 text-xs">2 分鐘前</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 如果工單不存在 -->
    <div th:if="${job == null}" class="text-center py-16">
      <div class="text-6xl mb-4">❌</div>
      <div class="text-xl font-semibold text-gray-700 mb-2">工單不存在</div>
      <div class="text-gray-500 mb-6">您查詢的工單可能已被刪除或不存在</div>
      <a href="/jobs" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
        返回工單列表
      </a>
    </div>
  </div>
</body>
</html>