<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢å®‰è£è¨‚å–® - æ™ºæ…§å®‰è£æ’ç¨‹å¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
  <div class="max-w-4xl mx-auto p-6">
    <!-- æ¨™é¡Œåˆ— -->
    <div class="flex items-center gap-3 mb-6">
      <a class="px-4 py-2 rounded-xl border border-gray-300 hover:bg-white transition-colors" href="/dashboard">â† è¿”å›ç¸½è¦½</a>
      <div class="text-2xl font-bold text-gray-900">æ–°å¢å®‰è£è¨‚å–®</div>
      <span class="ml-2 inline-flex items-center rounded-full bg-green-100 text-green-800 px-3 py-1 text-sm font-medium">æ™ºæ…§æ’ç¨‹ç³»çµ±</span>
    </div>

    <!-- ç•¶å‰åº«å­˜ç‹€æ³æé†’ - å¾è³‡æ–™åº«å‹•æ…‹è¼‰å…¥ -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
      <h3 class="font-semibold text-blue-900 mb-3">ğŸ” ç•¶å‰åº«å­˜ç‹€æ³</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center bg-white rounded-lg p-3" th:each="inv : ${inventoryStatus}">
          <div class="text-2xl font-mono font-bold" 
               th:classappend="${inv.hasShortage()} ? 'text-red-600' : 'text-blue-700'"
               th:text="${inv.qtyOnHand}">0</div>
          <div class="text-sm" 
               th:classappend="${inv.hasShortage()} ? 'text-red-600' : 'text-blue-600'"
               th:text="${inv.material}">ææ–™åç¨±</div>
          <div class="text-xs text-gray-500 mt-1">
            ç¸½éœ€æ±‚: <span th:text="${inv.totalDemand}">0</span>
            <span th:if="${inv.hasShortage()}" class="text-red-500 font-medium">
              (ç¼º <span th:text="${inv.shortage}">0</span>)
            </span>
          </div>
          <!-- åº«å­˜é€²åº¦æ¢ -->
          <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
            <div class="h-1.5 rounded-full transition-all"
                 th:classappend="${inv.hasShortage()} ? 'bg-red-500' : 'bg-blue-500'">
                 </div>
          </div>
        </div>
      </div>
      <div class="mt-3 text-xs text-blue-700 bg-blue-100 rounded p-2">
        ğŸ’¡ <strong>æ™ºæ…§æç¤ºï¼š</strong>ç³»çµ±å°‡æ ¹æ“šåº«å­˜ç‹€æ³å’Œæˆªæ­¢æ—¥æœŸè‡ªå‹•å„ªåŒ–æ’ç¨‹é †åºï¼Œç¢ºä¿ææ–™å……è¶³çš„è¨‚å–®å„ªå…ˆè™•ç†ã€‚
      </div>
    </div>

    <!-- è¨‚å–®è¼¸å…¥è¡¨å–® -->
    <form id="orderForm" action="/orders/create" method="post" class="bg-white rounded-2xl border border-gray-200 shadow-sm">
      <div class="px-6 py-4 border-b border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900">è¨‚å–®åŸºæœ¬è³‡æ–™</h3>
        <p class="text-sm text-gray-500 mt-1">è«‹å¡«å¯«æ©Ÿå°è³‡è¨Šå’Œææ–™éœ€æ±‚ï¼Œç³»çµ±å°‡è‡ªå‹•é€²è¡Œæ’ç¨‹è¨ˆç®—</p>
      </div>
      <div class="p-6 space-y-6">
        <!-- æ©Ÿå°è³‡è¨Š -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              æ©Ÿå°åç¨± <span class="text-red-500">*</span>
            </label>
            <input type="text" name="machineName" required
                   placeholder="ä¾‹ï¼šM3, M4..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   pattern="^M\d+$" 
                   title="è«‹è¼¸å…¥æ ¼å¼å¦‚ M3, M4 çš„æ©Ÿå°åç¨±">
            <div class="text-xs text-gray-500 mt-1">æ ¼å¼ï¼šM + æ•¸å­— (å¦‚ M3)</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              æœŸæœ›å®Œæˆæ—¥æœŸ <span class="text-red-500">*</span>
            </label>
            <input type="date" name="dueDate" required
                   min="2025-08-15" max="2025-12-31"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <div class="text-xs text-gray-500 mt-1" id="dueDateHint">ç³»çµ±å°‡æ ¹æ“šæ­¤æ—¥æœŸå®‰æ’å„ªå…ˆé †åº</div>
          </div>
        </div>

        <!-- ææ–™éœ€æ±‚ -->
        <div>
          <h4 class="text-base font-semibold text-gray-900 mb-4">ææ–™éœ€æ±‚é‡</h4>
          <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥å„ç¨®ææ–™çš„éœ€æ±‚æ•¸é‡ï¼Œç³»çµ±æœƒè‡ªå‹•æª¢æŸ¥åº«å­˜ä¸¦å®‰æ’åˆ°è²¨è¨ˆåŠƒ</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="border rounded-lg p-4" th:each="inv, iterStat : ${inventoryStatus}"
                 th:classappend="${inv.hasShortage()} ? 'border-red-300 bg-red-50' : 'border-gray-200'">
              <label class="block text-sm font-medium mb-2"
                     th:classappend="${inv.hasShortage()} ? 'text-red-700' : 'text-gray-700'"
                     th:text="${inv.material}">ææ–™åç¨±</label>
              
              <input type="number" 
                     th:name="${inv.material == 'æ°®æ°£ç®¡'} ? 'nitrogenPipe' : (${inv.material == 'æ°´ç®¡'} ? 'waterPipe' : 'vacuumPipe')"
                     min="0" max="1000" step="1"
                     placeholder="0" 
                     class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 material-input"
                     th:data-material="${inv.material}"
                     th:data-available="${inv.qtyOnHand}">
              
              <div class="text-xs mt-2">
                <div class="text-gray-600">å–®ä½ï¼šå…¬å°º</div>
                <div th:classappend="${inv.hasShortage()} ? 'text-red-600' : 'text-green-600'">
                  ç›®å‰åº«å­˜ï¼š<span class="font-mono" th:text="${inv.qtyOnHand}">0</span>
                </div>
                <div class="text-gray-500">
                  æ—¢æœ‰éœ€æ±‚ï¼š<span class="font-mono" th:text="${inv.totalDemand}">0</span>
                </div>
              </div>
              
              <!-- å³æ™‚æç¤ºå€åŸŸ -->
              <div class="material-hint mt-2 text-xs hidden">
                <div class="p-2 rounded bg-gray-100">
                  <span class="hint-text"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å¿«é€Ÿæ¸¬è©¦å ´æ™¯ -->
        <div>
          <h4 class="text-base font-semibold text-gray-900 mb-4">ğŸš€ å¿«é€Ÿæ¸¬è©¦å ´æ™¯</h4>
          <p class="text-sm text-gray-600 mb-4">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¿«é€Ÿå¡«å…¥æ¸¬è©¦æ•¸æ“šï¼Œé©—è­‰æ’ç¨‹åŠŸèƒ½</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button type="button" onclick="fillTestScenario1()" 
                    class="p-4 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
              <div class="text-sm font-medium text-blue-700">æƒ…å¢ƒï¼šæ€¥ä»¶æ’å–®æ¸¬è©¦</div>
              <div class="text-xs text-blue-600 mt-1">M2 æ©Ÿå°ï¼Œ2025/10/01 æˆªæ­¢</div>
              <div class="text-xs text-blue-600">æ°®æ°£ç®¡80ï¼Œæ°´ç®¡50ï¼ŒçœŸç©ºç®¡30</div>
              <div class="text-xs text-blue-500 mt-1">âš¡ æ¨¡æ“¬ç·Šæ€¥è¨‚å–®æ’å…¥ç¾æœ‰æ’ç¨‹</div>
            </button>
            <button type="button" onclick="fillTestScenario2()" 
                    class="p-4 border-2 border-dashed border-green-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors">
              <div class="text-sm font-medium text-green-700">æƒ…å¢ƒï¼šå¸¸è¦è¨‚å–®æ¸¬è©¦</div>
              <div class="text-xs text-green-600 mt-1">M3 æ©Ÿå°ï¼Œ2025/11/15 æˆªæ­¢</div>
              <div class="text-xs text-green-600">æ°®æ°£ç®¡40ï¼Œæ°´ç®¡30ï¼ŒçœŸç©ºç®¡20</div>
              <div class="text-xs text-green-500 mt-1">ğŸ“… æ¨¡æ“¬è¼ƒå¯¬é¬†æ™‚é–“çš„è¨‚å–®</div>
            </button>
          </div>
        </div>

        <!-- æäº¤æŒ‰éˆ• -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-100">
          <div class="text-sm text-gray-500">
            <div>ç­–ç•¥æ¨¡å¼ï¼š<span class="font-mono bg-gray-100 px-2 py-1 rounded">Partial</span> (åˆ†æ‰¹è™•ç†æ¨¡å¼)</div>
            <div class="text-xs text-gray-400 mt-1">ç³»çµ±å°‡æ ¹æ“šææ–™åˆ°è²¨æƒ…æ³åˆ†æ‰¹åŸ·è¡Œå®‰è£ä»»å‹™</div>
          </div>
          <div class="flex gap-3">
            <button type="button" onclick="previewOrder()" 
                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
              ğŸ” é è¦½å½±éŸ¿
            </button>
            <button type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              âœ… æäº¤è¨‚å–®
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- é è¦½çµæœå€åŸŸ -->
    <div id="previewResult" class="hidden mt-6 bg-white rounded-2xl border border-gray-200 shadow-sm">
      <div class="px-6 py-4 border-b border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900">ğŸ“Š æ’ç¨‹å½±éŸ¿é è¦½</h3>
        <p class="text-sm text-gray-500 mt-1">åŸºæ–¼ç•¶å‰åº«å­˜å’Œæ—¢æœ‰è¨‚å–®çš„åˆæ­¥åˆ†æ</p>
      </div>
      <div class="p-6">
        <div id="previewContent">
          <!-- å‹•æ…‹è¼‰å…¥é è¦½å…§å®¹ -->
        </div>
      </div>
    </div>

    <!-- æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ -->
    <div th:if="${param.success}" class="mt-4 bg-green-50 border border-green-200 rounded-xl p-4">
      <div class="text-green-800 font-medium">âœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼</div>
      <div class="text-green-700 text-sm mt-1" th:text="${param.success}">ç³»çµ±æ­£åœ¨é‡æ–°è¨ˆç®—æ’ç¨‹...</div>
    </div>
    
    <div th:if="${param.error}" class="mt-4 bg-red-50 border border-red-200 rounded-xl p-4">
      <div class="text-red-800 font-medium">âŒ è¨‚å–®å»ºç«‹å¤±æ•—</div>
      <div class="text-red-700 text-sm mt-1" th:text="${param.error}">è«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™</div>
    </div>

  </div>

  <script>
    // ææ–™è¼¸å…¥å³æ™‚æª¢æŸ¥
    document.addEventListener('DOMContentLoaded', function() {
      const materialInputs = document.querySelectorAll('.material-input');
      
      materialInputs.forEach(input => {
        input.addEventListener('input', function() {
          checkMaterialRequirement(this);
        });
      });
      
      // è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
      const today = new Date().toISOString().split('T')[0];
      document.querySelector('input[name="dueDate"]').min = today;
      
      // æ—¥æœŸé¸æ“‡æç¤º
      document.querySelector('input[name="dueDate"]').addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const today = new Date();
        const daysDiff = Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24));
        
        const hintElement = document.getElementById('dueDateHint');
        if (daysDiff < 30) {
          hintElement.textContent = `âš¡ æ€¥ä»¶ (${daysDiff}å¤©å¾Œ) - å°‡å„ªå…ˆæ’ç¨‹`;
          hintElement.className = 'text-xs text-orange-600 mt-1 font-medium';
        } else if (daysDiff < 90) {
          hintElement.textContent = `ğŸ“… æ¨™æº–æœŸç¨‹ (${daysDiff}å¤©å¾Œ) - æ­£å¸¸æ’ç¨‹`;
          hintElement.className = 'text-xs text-green-600 mt-1';
        } else {
          hintElement.textContent = `ğŸ• å¯¬é¬†æœŸç¨‹ (${daysDiff}å¤©å¾Œ) - å¯éˆæ´»å®‰æ’`;
          hintElement.className = 'text-xs text-blue-600 mt-1';
        }
      });
    });

    function checkMaterialRequirement(input) {
      const requested = parseInt(input.value) || 0;
      const available = parseInt(input.dataset.available) || 0;
      const materialName = input.dataset.material;
      const hintElement = input.parentElement.querySelector('.material-hint');
      const hintText = hintElement.querySelector('.hint-text');
      
      if (requested === 0) {
        hintElement.classList.add('hidden');
        return;
      }
      
      hintElement.classList.remove('hidden');
      
      if (requested <= available) {
        hintElement.querySelector('.p-2').className = 'p-2 rounded bg-green-100';
        hintText.innerHTML = `âœ… åº«å­˜å……è¶³ï¼šéœ€è¦ ${requested}ï¼Œå¯ç”¨ ${available}`;
      } else {
        hintElement.querySelector('.p-2').className = 'p-2 rounded bg-yellow-100';
        const shortage = requested - available;
        hintText.innerHTML = `âš ï¸ éœ€è£œæ–™ï¼šéœ€è¦ ${requested}ï¼Œåº«å­˜ ${available}ï¼Œç¼º ${shortage}<br><small class="text-gray-600">ç³»çµ±å°‡å®‰æ’åˆ†æ‰¹åˆ°è²¨è™•ç†</small>`;
      }
    }

    // æ¸¬è©¦å ´æ™¯å¡«å…¥åŠŸèƒ½
    function fillTestScenario1() {
      document.querySelector('input[name="machineName"]').value = 'M2';
      document.querySelector('input[name="dueDate"]').value = '2025-10-01';
      document.querySelector('input[name="nitrogenPipe"]').value = '80';
      document.querySelector('input[name="waterPipe"]').value = '50';
      document.querySelector('input[name="vacuumPipe"]').value = '30';
      
      // è§¸ç™¼æª¢æŸ¥
      document.querySelectorAll('.material-input').forEach(input => {
        if (input.value) checkMaterialRequirement(input);
      });
      
      // è§¸ç™¼æ—¥æœŸæç¤º
      document.querySelector('input[name="dueDate"]').dispatchEvent(new Event('change'));
    }

    function fillTestScenario2() {
      document.querySelector('input[name="machineName"]').value = 'M3';
      document.querySelector('input[name="dueDate"]').value = '2025-11-15';
      document.querySelector('input[name="nitrogenPipe"]').value = '40';
      document.querySelector('input[name="waterPipe"]').value = '30';
      document.querySelector('input[name="vacuumPipe"]').value = '20';
      
      // è§¸ç™¼æª¢æŸ¥
      document.querySelectorAll('.material-input').forEach(input => {
        if (input.value) checkMaterialRequirement(input);
      });
      
      // è§¸ç™¼æ—¥æœŸæç¤º
      document.querySelector('input[name="dueDate"]').dispatchEvent(new Event('change'));
    }

    // é è¦½åŠŸèƒ½
    function previewOrder() {
      const formData = new FormData(document.getElementById('orderForm'));
      const orderData = Object.fromEntries(formData);
      
      if (!orderData.machineName || !orderData.dueDate) {
        alert('è«‹å…ˆå¡«å¯«æ©Ÿå°åç¨±å’Œæˆªæ­¢æ—¥æœŸ');
        return;
      }
      
      showPreview(orderData);
    }

    function showPreview(orderData) {
      const previewDiv = document.getElementById('previewResult');
      const contentDiv = document.getElementById('previewContent');
      
      const materials = [
        { name: 'æ°®æ°£ç®¡', need: parseInt(orderData.nitrogenPipe) || 0, stock: 30 },
        { name: 'æ°´ç®¡', need: parseInt(orderData.waterPipe) || 0, stock: 20 },
        { name: 'çœŸç©ºç®¡', need: parseInt(orderData.vacuumPipe) || 0, stock: 10 }
      ];
      
      const totalNeed = materials.reduce((sum, m) => sum + m.need, 0);
      const hasShortage = materials.some(m => m.need > m.stock);
      
      contentDiv.innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="font-medium text-blue-900">ğŸ“¦ ææ–™éœ€æ±‚åˆ†æ</h4>
              <div class="mt-2 space-y-2">
                ${materials.map(m => `
                  <div class="flex justify-between text-sm ${m.need > m.stock ? 'text-orange-700' : 'text-blue-700'}">
                    <span>${m.name}ï¼š${m.need}</span>
                    <span>åº«å­˜ï¼š${m.stock} ${m.need > m.stock ? 'âš ï¸' : 'âœ…'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h4 class="font-medium text-gray-900">ğŸ“… æ’ç¨‹åˆ†æ</h4>
              <div class="mt-2 text-sm text-gray-700">
                <div>æ©Ÿå°ï¼š${orderData.machineName}</div>
                <div>æˆªæ­¢ï¼š${orderData.dueDate}</div>
                <div>ç¸½éœ€æ±‚ï¼š${totalNeed} å–®ä½</div>
                <div class="mt-2 ${hasShortage ? 'text-orange-700' : 'text-green-700'}">
                  ${hasShortage ? 'âš ï¸ éœ€è¦ç­‰å¾…åˆ†æ‰¹åˆ°è²¨' : 'âœ… å¯ç«‹å³é–‹å§‹è™•ç†'}
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-medium text-yellow-900">âš¡ æ’ç¨‹å½±éŸ¿é æ¸¬</h4>
            <div class="mt-2 text-sm text-yellow-800">
              <div>â€¢ æ–°è¨‚å–®å°‡ä¾æˆªæ­¢æ—¥æœŸ ${orderData.dueDate} æ’å…¥æ’ç¨‹åºåˆ—</div>
              <div>â€¢ ${hasShortage ? 'éƒ¨åˆ†ææ–™éœ€ç­‰å¾…8-9æœˆåˆ†æ‰¹åˆ°è²¨' : 'ææ–™åº«å­˜å……è¶³ï¼Œå¯å„ªå…ˆè™•ç†'}</div>
              <div>â€¢ å¯èƒ½å½±éŸ¿æ—¢æœ‰è¨‚å–® M1ã€M2 çš„è³‡æºåˆ†é…</div>
            </div>
          </div>
          
          <div class="text-sm text-gray-600 bg-gray-50 rounded p-3">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>é€™æ˜¯åŸºæ–¼ç•¶å‰æ•¸æ“šçš„åˆæ­¥é è¦½ï¼Œå¯¦éš›æ’ç¨‹çµæœå°‡åœ¨æäº¤å¾Œç”±ç³»çµ±ç²¾ç¢ºè¨ˆç®—ã€‚ç³»çµ±æœƒè€ƒæ…®å·¥äººç”¢èƒ½ã€ææ–™åˆ°è²¨æ™‚é–“ç­‰æ‰€æœ‰å› ç´ ã€‚
          </div>
        </div>
      `;
      
      previewDiv.classList.remove('hidden');
      previewDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // è¡¨å–®æäº¤è™•ç†
    document.getElementById('orderForm').addEventListener('submit', function(e) {
      const machineName = document.querySelector('input[name="machineName"]').value;
      const dueDate = document.querySelector('input[name="dueDate"]').value;
      
      if (!machineName || !dueDate) {
        e.preventDefault();
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šæ©Ÿå°åç¨±å’Œæˆªæ­¢æ—¥æœŸ');
        return;
      }
      
      // æª¢æŸ¥æ©Ÿå°åç¨±æ ¼å¼
      if (!/^M\d+$/.test(machineName)) {
        e.preventDefault();
        alert('æ©Ÿå°åç¨±æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥å¦‚ M3, M4 çš„æ ¼å¼');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹ææ–™éœ€æ±‚
      const nitrogenPipe = parseInt(document.querySelector('input[name="nitrogenPipe"]').value) || 0;
      const waterPipe = parseInt(document.querySelector('input[name="waterPipe"]').value) || 0;
      const vacuumPipe = parseInt(document.querySelector('input[name="vacuumPipe"]').value) || 0;
      
      if (nitrogenPipe === 0 && waterPipe === 0 && vacuumPipe === 0) {
        e.preventDefault();
        alert('è«‹è‡³å°‘å¡«å¯«ä¸€ç¨®ææ–™çš„éœ€æ±‚é‡');
        return;
      }
      
      // é¡¯ç¤ºæäº¤ä¸­ç‹€æ…‹
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'â³ æäº¤ä¸­...';
    });
  </script>
</body>
</html>